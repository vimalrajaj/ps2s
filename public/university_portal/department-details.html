<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Department Details - University Portal</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style-premium.css">
    <style>
        .department-layout {
            min-height: 100vh;
            display: flex;
        }
        
        .left-sidebar {
            width: 30%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            overflow-y: auto;
            position: relative;
        }
        
        .right-content {
            width: 70%;
            background: #f8fafc;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 2rem;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            text-align: center;
        }
        
        .department-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }
        
        .department-code {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 0.5rem;
        }
        
        .add-year-section {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .add-year-btn {
            width: 100%;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.3s ease;
        }
        
        .add-year-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            color: white;
            transform: translateY(-2px);
        }
        
        .academic-years-list {
            padding: 1rem;
        }
        
        .year-item {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .year-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(5px);
        }
        
        .year-item.active {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }
        
        .year-item-header {
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .year-actions {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .year-item:hover .year-actions {
            opacity: 1;
        }
        
        .year-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }
        
        .year-stats {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-top: 0.5rem;
        }
        
        .add-class-section {
            position: absolute;
            bottom: 2rem;
            left: 1rem;
            right: 1rem;
        }
        
        .add-class-btn {
            width: 100%;
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .add-class-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(67, 233, 123, 0.4);
        }
        
        .content-header {
            background: white;
            padding: 2rem;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .content-body {
            padding: 2rem;
        }
        
        .welcome-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #6b7280;
        }
        
        .welcome-icon {
            font-size: 4rem;
            color: #d1d5db;
            margin-bottom: 2rem;
        }
        
        .class-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .class-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        
        .class-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .class-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .class-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }
        
        .class-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .class-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #6b7280;
        }
        
        .capacity-bar {
            background: #f3f4f6;
            border-radius: 8px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .capacity-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            border-radius: 8px;
            transition: width 0.3s ease;
        }
        
        .capacity-fill.warning {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }
        
        .capacity-fill.danger {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }
        
        .class-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-students {
            background: #dbeafe;
            color: #2563eb;
        }
        
        .btn-students:hover {
            background: #2563eb;
            color: white;
        }
        
        .btn-edit {
            background: #fef3c7;
            color: #d97706;
        }
        
        .btn-edit:hover {
            background: #d97706;
            color: white;
        }
        
        .btn-delete {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .btn-delete:hover {
            background: #dc2626;
            color: white;
        }
        
        .back-btn {
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 1000;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            color: #374151;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .back-btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
            color: #1f2937;
            text-decoration: none;
            transform: translateY(-2px);
        }

        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15) !important;
        }

        .avatar-circle {
            transition: all 0.3s ease;
        }

        .student-card:hover .avatar-circle {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-btn">
        <i class="fas fa-arrow-left me-2"></i>Back to Portal
    </a>

    <div class="department-layout">
        <!-- Left Sidebar (30%) -->
        <div class="left-sidebar">
            <div class="sidebar-header">
                <h1 class="department-title" id="departmentName">Loading...</h1>
                <p class="department-code" id="departmentCode"></p>
            </div>
            
            <div class="add-year-section">
                <button class="btn add-year-btn" onclick="showAddYearModal()">
                    <i class="fas fa-plus me-2"></i>Add Academic Year
                </button>
            </div>
            
            <div class="academic-years-list" id="academicYearsList">
                <!-- Academic years will be loaded here -->
            </div>
            
            <div class="add-class-section">
                <button class="btn add-class-btn" onclick="showAddClassModal()" id="addClassBtn" disabled>
                    <i class="fas fa-plus me-2"></i>Add Class
                </button>
            </div>
        </div>
        
        <!-- Right Content (70%) -->
        <div class="right-content">
            <div class="content-header">
                <h2 id="contentTitle">Select an Academic Year</h2>
                <p class="text-muted mb-0" id="contentSubtitle">Choose an academic year from the left sidebar to view its classes</p>
            </div>
            
            <div class="content-body">
                <div id="contentArea">
                    <div class="welcome-state">
                        <i class="fas fa-calendar-alt welcome-icon"></i>
                        <h3>Welcome to Department Management</h3>
                        <p>Select an academic year from the left sidebar to view and manage its classes.</p>
                        <p class="text-muted">You can add new academic years and classes using the buttons in the sidebar.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Add Academic Year Modal -->
    <div class="modal fade" id="addYearModal" tabindex="-1" aria-labelledby="addYearModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addYearModalLabel">
                        <i class="fas fa-calendar-plus me-2"></i>Add Academic Year
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addYearForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="startYear" class="form-label">Start Year *</label>
                                    <input type="number" class="form-control" id="startYear" min="2020" max="2030" value="2024" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="endYear" class="form-label">End Year *</label>
                                    <input type="number" class="form-control" id="endYear" min="2021" max="2031" value="2025" required>
                                </div>
                            </div>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Add Academic Year</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Class Modal -->
    <div class="modal fade" id="addClassModal" tabindex="-1" aria-labelledby="addClassModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addClassModalLabel">
                        <i class="fas fa-chalkboard me-2"></i>Add Class
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addClassForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="className" class="form-label">Class Name *</label>
                                    <input type="text" class="form-control" id="className" placeholder="e.g., First Year, Second Year" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="classSection" class="form-label">Section *</label>
                                    <input type="text" class="form-control" id="classSection" placeholder="e.g., A, B, C" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="roomNumber" class="form-label">Room Number</label>
                                    <input type="text" class="form-control" id="roomNumber" placeholder="e.g., 101, A-205">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="classTeacher" class="form-label">Class Teacher</label>
                                    <input type="text" class="form-control" id="classTeacher" placeholder="Optional">
                                </div>
                            </div>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-success">Add Class</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentDepartmentId = null;
        let currentAcademicYearId = null;
        
        // Get department ID from URL parameters
        function getDepartmentIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            currentDepartmentId = getDepartmentIdFromUrl();
            if (currentDepartmentId) {
                loadDepartmentDetails();
            } else {
                alert('Department ID not found. Redirecting to main portal.');
                window.location.href = 'index.html';
            }
        });
        
        // Load department details and academic years
        async function loadDepartmentDetails() {
            try {
                showLoading(true);
                const response = await fetch(`/api/departments/${currentDepartmentId}/details`);
                const data = await response.json();
                
                if (data.success) {
                    displayDepartmentInfo(data.department);
                    loadAcademicYears(data.academicYears);
                } else {
                    alert('Error loading department details');
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error('Error loading department details:', error);
                alert('Error loading department details');
                window.location.href = 'index.html';
            } finally {
                showLoading(false);
            }
        }
        
        // Display department information
        function displayDepartmentInfo(department) {
            document.getElementById('departmentName').textContent = department.name;
            document.getElementById('departmentCode').textContent = `Code: ${department.code}`;
            document.title = `${department.name} - Department Details`;
        }
        
        // Load and display academic years
        function loadAcademicYears(academicYears) {
            const container = document.getElementById('academicYearsList');
            
            if (!academicYears || academicYears.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-white-50 py-4">
                        <i class="fas fa-calendar-times fa-2x mb-3"></i>
                        <p>No academic years found.</p>
                        <p class="small">Add your first academic year using the button above.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            academicYears.forEach(year => {
                const yearElement = createAcademicYearElement(year);
                container.appendChild(yearElement);
            });
        }
        
        // Create academic year element
        function createAcademicYearElement(year) {
            const div = document.createElement('div');
            div.className = 'year-item';
            
            div.innerHTML = `
                <div class="year-item-header" onclick="selectAcademicYear(${year.id}, '${year.year_range}')">
                    <div>
                        <h3 class="year-title">${year.year_range}</h3>
                        <div class="year-stats">
                            <i class="fas fa-chalkboard me-1"></i>
                            <span id="classCount-${year.id}">Loading...</span> Classes
                        </div>
                    </div>
                    <div class="year-actions">
                        <button class="btn btn-sm btn-outline-light" onclick="event.stopPropagation(); removeAcademicYear(${year.id}, '${year.year_range}')" title="Remove Academic Year">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // Load class count for this year
            loadClassCount(year.id);
            
            return div;
        }
        
        // Load class count for academic year
        async function loadClassCount(yearId) {
            try {
                const response = await fetch(`/api/academic-years/${yearId}/classes`);
                const data = await response.json();
                
                if (data.success) {
                    const countElement = document.getElementById(`classCount-${yearId}`);
                    if (countElement) {
                        countElement.textContent = data.classes.length;
                    }
                }
            } catch (error) {
                console.error('Error loading class count:', error);
            }
        }
        
        // Select academic year and load classes
        async function selectAcademicYear(yearId, yearRange) {
            // Update active state
            document.querySelectorAll('.year-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            currentAcademicYearId = yearId;
            
            // Enable add class button
            document.getElementById('addClassBtn').disabled = false;
            
            // Update content header
            document.getElementById('contentTitle').textContent = `Classes in ${yearRange}`;
            document.getElementById('contentSubtitle').textContent = 'Manage classes and their student assignments';
            
            // Load classes for this academic year
            await loadClasses(yearId);
        }
        
        // Load classes for academic year
        async function loadClasses(yearId) {
            try {
                showLoading(true);
                const response = await fetch(`/api/academic-years/${yearId}/classes`);
                const data = await response.json();
                
                if (data.success) {
                    displayClasses(data.classes);
                } else {
                    console.error('Error loading classes:', data.message);
                }
            } catch (error) {
                console.error('Error loading classes:', error);
            } finally {
                showLoading(false);
            }
        }
        
        // Display classes
        function displayClasses(classes) {
            const container = document.getElementById('contentArea');
            
            if (!classes || classes.length === 0) {
                container.innerHTML = `
                    <div class="welcome-state">
                        <i class="fas fa-chalkboard welcome-icon"></i>
                        <h3>No Classes Found</h3>
                        <p>This academic year doesn't have any classes yet.</p>
                        <button class="btn btn-success" onclick="showAddClassModal()">
                            <i class="fas fa-plus me-2"></i>Add First Class
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="class-grid">';
            classes.forEach(cls => {
                const capacity = cls.capacity || 60;
                const current = cls.student_count || 0;
                const percentage = (current / capacity) * 100;
                const available = capacity - current;
                
                let capacityClass = '';
                if (percentage >= 90) capacityClass = 'danger';
                else if (percentage >= 75) capacityClass = 'warning';
                
                html += `
                    <div class="class-card">
                        <div class="class-header">
                            <h4 class="class-name">${cls.class_name}</h4>
                            <span class="class-section">Section ${cls.section}</span>
                        </div>
                        <div class="class-stats">
                            <div class="stat-item">
                                <div class="stat-number">${current}</div>
                                <div class="stat-label">Students</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${capacity}</div>
                                <div class="stat-label">Capacity</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${available}</div>
                                <div class="stat-label">Available</div>
                            </div>
                        </div>
                        <div class="capacity-bar">
                            <div class="capacity-fill ${capacityClass}" style="width: ${percentage}%"></div>
                        </div>
                        <div class="class-actions">
                            <button class="btn btn-icon btn-students" onclick="viewClassStudents(${cls.id}, '${cls.class_name}', '${cls.section}')" title="View Students">
                                <i class="fas fa-users"></i>
                            </button>
                            <button class="btn btn-icon btn-delete" onclick="deleteClass(${cls.id}, '${cls.class_name}', '${cls.section}')" title="Delete Class">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        ${cls.class_teacher ? `<div class="mt-2"><small class="text-muted"><i class="fas fa-user-tie me-1"></i>Teacher: ${cls.class_teacher}</small></div>` : ''}
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Show add academic year modal
        function showAddYearModal() {
            const modal = new bootstrap.Modal(document.getElementById('addYearModal'));
            modal.show();
        }
        
        // Show add class modal
        function showAddClassModal() {
            if (!currentAcademicYearId) {
                alert('Please select an academic year first');
                return;
            }
            const modal = new bootstrap.Modal(document.getElementById('addClassModal'));
            modal.show();
        }
        
        // Add academic year form handler
        document.getElementById('addYearForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const startYear = document.getElementById('startYear').value;
            const endYear = document.getElementById('endYear').value;
            
            if (parseInt(endYear) <= parseInt(startYear)) {
                alert('End year must be greater than start year');
                return;
            }
            
            try {
                showLoading(true);
                const response = await fetch(`/api/departments/${currentDepartmentId}/academic-years`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        start_year: startYear,
                        end_year: endYear
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Academic year added successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addYearModal')).hide();
                    loadDepartmentDetails(); // Reload the page data
                } else {
                    showNotification(data.message || 'Error adding academic year', 'error');
                }
            } catch (error) {
                console.error('Error adding academic year:', error);
                showNotification('Error adding academic year', 'error');
            } finally {
                showLoading(false);
            }
        });
        
        // Add class form handler
        document.getElementById('addClassForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const className = document.getElementById('className').value;
            const section = document.getElementById('classSection').value;
            const roomNumber = document.getElementById('roomNumber').value;
            const teacher = document.getElementById('classTeacher').value;
            
            if (!className || !section) {
                showNotification('Class name and section are required', 'error');
                return;
            }
            
            if (!currentDepartmentId) {
                showNotification('Department context not found. Please refresh the page.', 'error');
                return;
            }
            
            try {
                showLoading(true);
                const response = await fetch(`/api/academic-years/${currentAcademicYearId}/classes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        class_name: className,
                        section: section,
                        room_number: roomNumber || null,
                        class_teacher: teacher || null,
                        department_id: currentDepartmentId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Class added successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addClassModal')).hide();
                    document.getElementById('addClassForm').reset();
                    await loadClasses(currentAcademicYearId); // Reload classes
                    loadClassCount(currentAcademicYearId); // Update class count in sidebar
                } else {
                    showNotification(data.message || 'Error adding class', 'error');
                }
            } catch (error) {
                console.error('Error adding class:', error);
                showNotification('Error adding class', 'error');
            } finally {
                showLoading(false);
            }
        });
        
        // View class students (inline display)
        async function viewClassStudents(classId, className, section) {
            console.log(`🎯 Viewing students for class ${classId}: ${className} - Section ${section}`);
            // Redirect to the new professional students page
            window.open(`class-students.html?classId=${classId}`, '_blank');
        }
        
        // Display students inline below the class
        function displayStudentsInline(classId, students, className, section, mentor) {
            // Find the button that was clicked and get its parent class card
            const button = document.querySelector(`[onclick*="viewClassStudents(${classId},"]`);
            const classCard = button ? button.closest('.class-card') : null;
            
            if (!classCard) {
                console.error('Could not find class card for classId:', classId);
                return;
            }
            
            // Create inline display HTML with mentor info and student cards
            const studentsHTML = `
                <div id="students-${classId}" class="students-inline-display mt-4 p-4" style="
                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
                    border: 1px solid #dee2e6;
                    border-radius: 12px; 
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    margin-bottom: 2rem;
                ">
                    <!-- Header with close button -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0 text-primary">
                            <i class="fas fa-graduation-cap me-2"></i>
                            Students in ${className} - Section ${section}
                        </h5>
                        <button class="btn btn-sm btn-outline-danger" onclick="document.getElementById('students-${classId}').remove()" title="Close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- Mentor Information - Displayed prominently at the top -->
                    ${mentor ? `
                        <div class="mentor-section mb-4 p-3" style="
                            background: linear-gradient(135deg, #28a745, #20c997); 
                            color: white; 
                            border-radius: 10px;
                            box-shadow: 0 2px 4px rgba(40,167,69,0.3);
                        ">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-user-tie fa-lg me-3"></i>
                                <div>
                                    <h6 class="mb-1 text-white">Class Mentor: ${mentor.name || 'Not Assigned'}</h6>
                                    ${mentor.designation ? `<span class="badge bg-light text-dark">${mentor.designation}</span>` : ''}
                                </div>
                            </div>
                            <div class="row mt-2">
                                ${mentor.email ? `
                                    <div class="col-md-6">
                                        <small><i class="fas fa-envelope me-2"></i>${mentor.email}</small>
                                    </div>
                                ` : ''}
                                ${mentor.phone ? `
                                    <div class="col-md-6">
                                        <small><i class="fas fa-phone me-2"></i>${mentor.phone}</small>
                                    </div>
                                ` : ''}
                            </div>
                            ${mentor.assigned_date ? `
                                <div class="mt-2">
                                    <small><i class="fas fa-calendar me-1"></i>Assigned: ${new Date(mentor.assigned_date).toLocaleDateString()}</small>
                                </div>
                            ` : ''}
                        </div>
                    ` : `
                        <div class="mentor-section mb-4 p-3" style="
                            background: #fff3cd; 
                            color: #664d03; 
                            border-radius: 10px;
                            border: 1px solid #ffecb5;
                        ">
                            <div class="text-center">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>No Mentor Assigned to this Class</strong>
                            </div>
                        </div>
                    `}
                    
                    <!-- Students Cards Section -->
                    <div class="students-section">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0 text-secondary">
                                <i class="fas fa-users me-2"></i>
                                Students (${students ? students.length : 0})
                            </h6>
                            <button class="btn btn-outline-primary btn-sm" onclick="window.open('students-details.html?class=${classId}', '_blank')">
                                <i class="fas fa-list me-1"></i>View All Students
                            </button>
                        </div>
                        
                        ${students && students.length > 0 ? `
                            <div class="row">
                                ${students.slice(0, 6).map(student => `
                                    <div class="col-lg-4 col-md-6 mb-3">
                                        <div class="card h-100 student-card shadow-sm" style="border-radius: 10px; transition: all 0.3s ease;">
                                            <div class="card-body p-3">
                                                <div class="d-flex align-items-center mb-2">
                                                    <div class="avatar-circle me-3" style="
                                                        width: 40px; 
                                                        height: 40px; 
                                                        border-radius: 50%; 
                                                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                                        color: white;
                                                        display: flex;
                                                        align-items: center;
                                                        justify-content: center;
                                                        font-weight: bold;
                                                    ">
                                                        ${(student.first_name?.[0] || 'S').toUpperCase()}
                                                    </div>
                                                    <div class="flex-grow-1">
                                                        <h6 class="card-title mb-0">${student.first_name || ''} ${student.last_name || ''}</h6>
                                                        <small class="text-muted">${student.roll_number || 'N/A'}</small>
                                                    </div>
                                                </div>
                                                <div class="student-info mb-3">
                                                    <small class="d-block text-muted">
                                                        <i class="fas fa-graduation-cap me-1"></i>
                                                        Year ${student.current_year || 'N/A'} - Sem ${student.current_semester || 'N/A'}
                                                    </small>
                                                    <small class="d-block mt-1">
                                                        <span class="badge ${student.status === 'active' ? 'bg-success' : 'bg-warning'}">
                                                            ${student.status || 'N/A'}
                                                        </span>
                                                    </small>
                                                </div>
                                                <button class="btn btn-primary btn-sm w-100" onclick="window.open('student-profile.html?id=${student.id}', '_blank')" style="border-radius: 6px;">
                                                    <i class="fas fa-eye me-1"></i>View Details
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            ${students.length > 6 ? `
                                <div class="text-center mt-3">
                                    <button class="btn btn-outline-secondary" onclick="window.open('students-details.html?class=${classId}', '_blank')">
                                        <i class="fas fa-plus me-1"></i>Show ${students.length - 6} More Students
                                    </button>
                                </div>
                            ` : ''}
                        ` : `
                            <div class="text-center py-5" style="background: white; border-radius: 8px; border: 2px dashed #dee2e6;">
                                <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted">No Students Enrolled</h6>
                                <p class="text-muted mb-0">This class doesn't have any students yet.</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            // Insert the students display after the class card
            classCard.insertAdjacentHTML('afterend', studentsHTML);
            
            // Scroll to the students display smoothly
            setTimeout(() => {
                const studentsElement = document.getElementById(`students-${classId}`);
                if (studentsElement) {
                    studentsElement.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start',
                        inline: 'nearest'
                    });
                }
            }, 100);
        }
        

        
        // Delete class
        async function deleteClass(classId, className, section) {
            if (!confirm(`Are you sure you want to delete ${className} - Section ${section}?`)) {
                return;
            }
            
            try {
                showLoading(true);
                const response = await fetch(`/api/classes/${classId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Class deleted successfully!', 'success');
                    await loadClasses(currentAcademicYearId); // Reload classes
                    loadClassCount(currentAcademicYearId); // Update class count in sidebar
                } else {
                    showNotification(data.message || 'Error deleting class', 'error');
                }
            } catch (error) {
                console.error('Error deleting class:', error);
                showNotification('Error deleting class', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Remove academic year
        async function removeAcademicYear(yearId, yearRange) {
            if (!confirm(`Are you sure you want to remove the academic year ${yearRange}?\n\nThis will also delete all classes and students in this academic year.`)) {
                return;
            }
            
            try {
                showLoading(true);
                const response = await fetch(`/api/academic-years/${yearId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Academic year removed successfully!', 'success');
                    // If this was the currently selected year, reset the view
                    if (currentAcademicYearId === yearId) {
                        currentAcademicYearId = null;
                        document.getElementById('addClassBtn').disabled = true;
                        document.getElementById('contentTitle').textContent = 'Select an Academic Year';
                        document.getElementById('contentSubtitle').textContent = 'Choose an academic year from the left sidebar to view its classes';
                        document.getElementById('contentArea').innerHTML = `
                            <div class="welcome-state">
                                <i class="fas fa-calendar-alt welcome-icon"></i>
                                <h3>Welcome to Department Management</h3>
                                <p>Select an academic year from the left sidebar to view and manage its classes.</p>
                                <p class="text-muted">You can add new academic years and classes using the buttons in the sidebar.</p>
                            </div>
                        `;
                    }
                    loadDepartmentDetails(); // Reload the page data
                } else {
                    showNotification(data.message || 'Error removing academic year', 'error');
                }
            } catch (error) {
                console.error('Error removing academic year:', error);
                showNotification('Error removing academic year', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Show loading spinner
        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            spinner.style.display = show ? 'flex' : 'none';
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            notification.style.minWidth = '300px';
            
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>